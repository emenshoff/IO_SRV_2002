<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN">
<!-- saved from url=(0048)http://www.stm.rest.ru/formats/drivers/gsdrv.htm -->
<HTML><HEAD><TITLE>Net server TM</TITLE>
<META content="text/html; charset=windows-1251" http-equiv=Content-Type><!-- Meta http equivalent was here                                      -->
<META content="MSHTML 5.00.2920.0" name=GENERATOR><!-- Составлено swd, Правлено AZ --></HEAD>
<BODY aLink=#000099 bgColor=#99cc99 link=#0000cc vLink=#000099>
<H2 align=center><FONT color=#000090>Драйвер КП "Гранит"</FONT></H2>
<H2 align=center><FONT color=#0000ff>KP</FONT><FONT color=#800000>DRV</FONT> 
</H2>
<HR SIZE=5>

<P>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Драйвер KPDRV служит 
интерфейсным модулем между аппаратурой КП (ПУ) "Гранит" с одной стороны и 
сервером телеметрии (модуль "master") c другой 
стороны.<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Драйвер обрабатывает 
поступающие от КП "Гранит" пакеты данных и преобразет их в объекты типов:<BR>TSd 
- телесигнал "драйверный";<BR>TITd - телеизмерение текущее "драйверное";<BR>TIId 
- интегральное измерение "драйверное" (от субблоков ТИИ);<BR>TITid - 
интегральное или усредненное измерение, вычисленное в драйвере из TITd за 
определенный отрезок времени;<BR>KPd - состояние КП и его 
субблоков.<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Драйвер принимает 
от сервера объекты и преобразует их в информационные пакеты для КП "Гранит": 
<BR>TUd - телеуправление - объект драйверный<BR>Light - вывод индикации на 
субблоки типа КС-35.26 и КС-35.26-1.</P>
<P>Драйвер и сервер обмениваются служебными управляющими пакетами.</P>
<P>Для работы драйверу требуется исходная информация с описанием первичных 
данных поступающих (передаваемых) от (к) КП "Гранит". Для описания используется 
текстовый <A 
href="http://www.stm.rest.ru/formats/drivers/gsdrv.htm#example">файл 
конфигурации</A>.<BR></P>
<DIV align=center>
<CENTER>
<TABLE border=1>
  <TBODY>
  <TR>
    <TD><FONT size=5><B>Краткое описание 
  функционирования.</B></FONT></TD></TR></TBODY></TABLE></CENTER></DIV>
<P align=left>Драйвер для физического подключения к аппаратуре использует 
синхронно-асинхронный адаптер производства НТК "Интерфейс". Сам драйвер в STM 
является синонимом понятия "сервер данных", присутствующим в других системах, 
так как может работать на отдельенной от сервера платформе (например на 
удаленной ПЭВМ), связь с сервером при этом будет производиться по сокету TCP/IP. 
Однако как правило он функционирует на одной с сервером платформе и поддерживает 
свяъ по UNIX сокету, что требует меньших ресурсов процессора. Драйвер может быть 
выгружен и загружен при работающем сервере, в том числе с обновленным <A 
href="http://www.stm.rest.ru/formats/drivers/gsdrv.htm#example">файлом 
конфигурации</A>. Характеристики и перечень объектов согласовываются 
автоматически так, как это описано в спецификации " <A 
href="http://www.stm.rest.ru/formats/st_drv.htm">протокола обмена сервер - 
драйвер</A> ". </P>
<P align=left>Драйвер при старте согласовывает с сервером имена контролируемых 
им объектов и в дальнейшем обменивается уже числовыми идентификаторами, а не 
именами, затем серверу высылаются значения всех полей по каждому типа с 
предустановленными значениями. <BR>Сервер имеет возможность изменить значения 
полей драйверных объектов после загрузки драйвера, например изменить значение 
аварийной уставки или коэффициента kA. В настоящей версии эти изменения 
драйвером не запоминаются, в очередной версии это будет реализовано. Вообще эта 
версия драйвера запоминает в отдельном файле (light.val) только состояние 
объектов Light (вывод на лампочный щит), таким образом сохраняя оборудование и 
нервы дежурного персонала в стабильном состоянии.<BR>Драйвер самостоятельно 
следит за состоянием функциональнх блоков на КП путем их периодического опроса с 
заданной в конфигурационном файле периодичностью. Если субблок на КП 
самостоятельно и достаточно часто шлет информационные посылки (например ТИТ), то 
он не подлежит опросу, однако как только будет зафиксировано отсутствие его 
посылок более (LimitTime*StartPoll/100)сек. начнется его опрос с частотой не 
чаще чем PollDelay. Командой с сервера можно искуственно вызвать опрос всех 
субблоков всех КП и передачу всех достоверных TSd серверу.<BR>В процессе работы 
драйвер высылает серверу только обновленные значения изменившихся полей, а так 
же некоторых сопутствующих полей. Конкретный перечень полей зависит от типа и 
его можно увидеть запустив "трассировку" конкретного объекта на сервере. Следует 
отметить что со значением измененного поля объекта выдается время, если есть 
необходимость - признак достоверности, а для TITd выдается как квантовое, так и 
именованое значение. Выдача происходит через FIFO буфер большого размера, таким 
образом обеспечивается асинхронность работы драйвера и сервера.<BR>Приоритеты 
выдачи серверу: <BR>- TSd;<BR>- TIId и TITid;<BR>- TITd.<BR>Естественно 
информационные посылки от КП, на КП, от сервера и к серверу проходят 
определенное количество фильтров и проверок, что гарантирует надежное 
функционирование драйвера и точность его "показаний".<BR>В целях облегчения 
наладки прохождение посылок и объектов внутри драйвера "трассируется" по виду 
телеинформации, по функциям драйвера, по конкретным объектам контроля. На 
трассировку могут быть наложены фильтры по номеру КП, АФБ, порту связи. 
Информация о результате "трассировки" сбрасывается в "кольцевой" файл kpdrv.log. 
Информация о возможных ошибках в информационных посылках от КП и данных 
передаваемых драйверу от сервера записывается в этот же файл даже при включенной 
трассировке. Запись kpdrv.log может быть полностью отключена только 
соответствующим флагом в файле dump.conf.</P>
<P align=left>&nbsp;</P>
<DIV align=center>
<CENTER>
<TABLE border=1>
  <TBODY>
  <TR>
    <TD><FONT size=5><B>Формальное описание файла конфигурации 
      драйвера.</B></FONT></TD></TR></TBODY></TABLE></CENTER></DIV>
<P align=center>&nbsp;</P>
<P>Описание исходит из принадлежности драйверных объектов к конкретному КП, 
функциональному блоку и положению в информационной посылке.</P>
<HR>

<P>Укрупненно, структуру базы можно описать так:<BR>%KP=НОМЕР, 
ИМЯ;<BR>{<BR>&nbsp;&nbsp;AFB1<BR>&nbsp;&nbsp;AFB2<BR>&nbsp;&nbsp;...<BR>&nbsp;&nbsp;AFB16<BR>}<BR>Описания 
различных КП могут следовать друг за другом в любом порядке или даже находиться 
в различных файлах. Номера КП могут иметь диапазон 1..250. Каждый КП 
<B>должен</B> иметь уникальное имя.</P>
<HR>

<P>Описания функциональных блоков (AFB), расположены внутри описания КП и 
строятся по такому же принципу.<BR>%AFB=НОМЕР, ТИП;<BR>{<BR>&nbsp;&nbsp;Описание 
параметра;<BR>&nbsp;&nbsp;Описание параметра;<BR>&nbsp;&nbsp;...<BR>}</P>
<P>Номера АФБ могут иметь вид 1..16 , (номер 1 соответствует 6 слоту в каркасе 
КП Гранит).<BR></P>
<HR>

<P>Внутри описания АФБ находится описание конкретных параметров принадлежих 
этому субблоку.<BR>Описание параметра имеет вид:<BR><FONT 
color=#804040>%ТИП=</FONT>Имя&nbsp;Параметра<FONT color=#804040>; 
%GR=</FONT>Номер&nbsp;группы<FONT color=#804040>; 
%NUM=</FONT>Номер&nbsp;в&nbsp;группе;<BR>{<BR>&nbsp;&nbsp;&nbsp;Дополнительные 
параметры;<BR>}</P>
<P>Имя параметра должно быть уникальным в рамках одного типа. Номер группы 
задается только для параметров типа TITd и может иметь значение 0-1 , при этом 
имеет значение только чeтность номера.<BR>Номера в группе начинаются с 1 и имеют 
диапазон в зависимости от функциональной принадлежности.<BR>Для <FONT 
size=4><B><TT>TS</TT></B></FONT> диапазон номеров 1..64, для <FONT 
size=4><B><TT>TIT</TT></B></FONT> 1..16, для <FONT size=4><B><TT>TII 
</TT></B></FONT>1..16.</P>
<P>Синтаксис описания дополнительных параметров зависит от функциональной 
принадлежности, но обладает общими свойствами для всех типов параметров. Все они 
описываются с помощью группы операторов языка имеющих вид: <FONT 
color=#804040>Ключевое&nbsp;слово=</FONT>Значение<FONT 
color=#804040>;</FONT></P>
<P align=center><FONT color=#804040></FONT>&nbsp;</P>
<DIV align=center>
<CENTER><A name=example></A>
<TABLE border=1>
  <TBODY>
  <TR>
    <TD><FONT size=5><B>Пример описания конкретного файла конфигурации 
      драйвера.</B></FONT></TD></TR></TBODY></TABLE></CENTER></DIV>
<P>// <FONT color=#ff0000>параметры по умолчанию-на все КП 
"Гранит"</FONT><BR>LimitTime = 180; // предельный интервал ожидания посылок, по 
истечению которого может быть выставлена недостоверность функционального блока 
КП, если от него небыло данных (диапазон допустимых значений 15 сек - 30 
мин);</P>
<P>StartPoll = 30; // <FONT color=#ffff00>Задержка начала опросов КП после 
начала интервала LimitTime - (25%-95%) значения LimitTime;</FONT></P>
<P>ObjTimes = 2; // <FONT color=#ffff00>число крат от LimitTime(1-10) для 
объявления недостоверными объектов, порождаемых из данных, функционального 
блока;</FONT></P>
<P>PollDelay = 50; //<FONT color=#ffff00> Выдавать опрос субблоков КП не чаще 
чем: в десятых долях секунды (0.5 -20 сек)</FONT></P>
<P>ValidTime = 5; // <FONT color=#ffff00>5 - в десятых долях секунды. Если 
очередное переключение ТС придет ранее чем (0.3-3 сек), относительно 
предыдущего, то это будет считаться дребезгом и объект типа TSd не будет 
отправлен серверу;</FONT><BR>TURetryOn = 1; // <FONT color=#ffff00>число 
автономных попыток драйвера при получении от сервера команды ТУ на включение 
(допустимо от1 до 5)</FONT><BR>TURetryOff = 3; // <FONT color=#ffff00>число 
автономных попыток драйвера при получении от сервера команды ТУ на выключение 
(допустимо от1 до 10)</FONT><BR>TUSilence = 20; // <FONT color=#ffff00>пауза в 
секундах перед повторной выдачей телеуправления на КП 
"Гранит"</FONT><BR>TUTimeOut = 50; //<FONT color=#ffff00> таймаут в секундах 
ожидания переключения TSd после подачи TUd</FONT><BR>// <FONT 
color=#ff0000>параметры на конкретное КП "Гранит"</FONT><BR>КP = 47, 
KP_047_Granit, 'KP_47';<BR>{<BR>// <FONT color=#ff0000><U>Здесь могут быть 
необязательные параметры:</U></FONT><BR>// LimitTime = 20; // <FONT 
color=#ffff00>Если у этого параметра будет снят комментарий - он начнет 
действовать вместо </FONT><FONT color=#ff0000>параметров по умолчанию-на все КП 
"Гранит"</FONT><BR>// StartPoll = 75; // <FONT color=#ffff00>-"-</FONT><BR>// 
ObjTimes = 2; //<FONT color=#ffff00> -"-</FONT><BR>// PollDelay = 2; // <FONT 
color=#ffff00>-"-</FONT><BR><BR>TS = 1; //<FONT color=#00ffff> </FONT><FONT 
color=#000080>описание блока ТС, установленного на место первого ФБ</FONT><BR>{ 
// <FONT color=#ffff00>Скобка начала описания блока TS</FONT><BR>// <FONT 
color=#ff0000><U>необязательные параметры</U></FONT><BR>ValidTime = 7; // <FONT 
color=#ffff00>время, считающееся дребезгом (в десятых долях секунды) - подменяет 
аналогичный параметр в списке </FONT><FONT color=#ff0000>параметров по 
умолчанию-на все КП "Гранит"</FONT><BR>TS = 1, TEST__TS1400, 'Тестовый сигнал 
0';<BR>{<BR>Type = 0;<BR>// <FONT color=#ffff00>вывод - "привязка" ТС к выводу 
на лампочный щит</FONT><BR>// <FONT color=#ffff00>Light = &lt; 32|64 &gt; , &lt; 
Номер КП (1..250) &gt; , &lt; АФБ (0..15) &gt; , &lt; Номер лампы (1..32(64)) 
&gt;</FONT><BR>Light = 32, 8, 14, 6;<BR>}<BR>// <FONT color=#ffff00>TS = 2 - это 
контакт к которому подключается 2-й датчик ТС на субблоке ТС</FONT><BR>TS = 2, 
TEST__TS1401, 'Тестовый сигнал 1'; // <FONT color=#ffff00>TEST__TS1401 - имя 
объекта типа TSd</FONT><BR>{//<FONT color=#ffff00>'Тестовый сигнал 1' - 
пояснение - комментарий к "TEST__TS1401"</FONT><BR>Type = 0; // <FONT 
color=#ffff00>Type = 0 - тип "обычный телесигнал"</FONT><BR>}<BR>TS = 3, 
TEST__TS1402, 'Тестовый сигнал 2';<BR>{<BR>Type = 0; <BR>}<BR>TS = 64, 
TEST__TS1463, 'Тестовый сигнал 63';<BR>{<BR>Type = 1; //<FONT color=#ffff00>Type 
= 1 - тип "телесигнал о неисправности"</FONT><BR>}<BR>}// <FONT 
color=#ffff00>Скобка конца описания блока TS</FONT><BR></P>
<P>TIT = 2; //<FONT color=#00ffff> </FONT><FONT color=#000080>описание блока 
ТИТ, установленного на место второго ФБ</FONT><BR>{ //<FONT color=#ffff00> 
Скобка начала описания блока TIT</FONT><BR>// <FONT color=#ff0000><U>Здесь могут 
быть еобязательные параметры</U></FONT><BR>TIT = 0, 1, Test_TIT_0001, 'Тестовый 
ТИТ 1'; //<FONT color=#ffff00>TIT = 0, 1- нулевая (четная) группа, первsй 
ТИТ</FONT><BR>{//<FONT color=#ffff00>Test_TIT_0000 - имя объекта типа 
TITd</FONT> //<FONT color=#ffff00>'Тестовый ТИТ 1</FONT> <FONT color=#ffff00>- 
комментарий</FONT><BR>aLo = 100; // <FONT color=#ffff00>- нижняя "аварийная" 
уставка </FONT><BR>tLo = 140; // <FONT color=#ffff00>- нижняя "технологическая" 
уставка </FONT><BR>aHi = 300; // <FONT color=#ffff00>- верхняя "аварийная" 
уставка </FONT><BR>tHi = 400; // <FONT color=#ffff00>- верхняя "технологическая" 
уставка </FONT><BR>kA = 0; // <FONT color=#ffff00>- коэффициент kA в формуле 
вычисления именованного значения ХХ=kB+квант.знач.*kA</FONT><BR>kB = 2; // <FONT 
color=#ffff00>- коэффициент kB в формуле вычисления именованного значения 
ХХ=kB+квант.знач.*kA</FONT><BR>Jump = 0; // <FONT color=#ffff00>- квантовое 
значение "скачка" или 0: если не 0 и очередное значение ТИТ больше (или меньше) 
величины Jump, серверу будет отправлен признак "скачка": -1 -если вниз; +1, если 
вверх; а так же само значение скачка. ** Обработка "скачка" может быть 
заблокирована черезмерной величиной Gist.</FONT><BR>Gist=2; // <FONT 
color=#ffff00>- процент гистерезиса от fHi, на квантовое значение ТИТ 
(нечувствительность к изменению квантовых значений)</FONT><BR>fLo = 0; // <FONT 
color=#ffff00>- нижнее квантовое значение субблока ТИТ</FONT><BR>fHi = 250; // 
<FONT color=#ffff00>- верхнее квантовое значение субблока ТИТ</FONT><BR>Kts = 0; 
// <FONT color=#ffff00>- Телесигнал контролирующий этот ТИТ или 0; Если Kts 
определен и находится в состоянии отключен, то значения этого ТИТ не 
обрабатываются</FONT><BR>}<BR><BR>TIT = 0, 2, Test_TIT_0002, 'Тестовый ТИТ 
2';<BR>{<BR>aLo = 100; tLo = 160; aHi = 400; tHi = 320; kA = 0; kB = 2; Jump = 
3;<BR>fLo = 0; fHi = 250; Kts = 0;<BR>}<BR><BR>TIT = 0, 16, Test_TIT_0016, 
'Тестовый ТИТ 16';<BR>{<BR>aLo = 150; tLo = 260; aHi = 500; tHi = 400; kA = 0; 
kB = 3; Jump = 5;<BR>fLo = 0; fHi = 250; Kts = 0; Gist=1;<BR>}<BR><BR>TIT = 1, 
1, Test_TIT_0017, 'Тестовый ТИТ 17'; //<FONT color=#ffff00>TIT = 1, 1- первая 
(нечетная) группа, 17-й ТИТ</FONT><BR>{<BR>aLo = 150; tLo = 200; aHi = 400; tHi 
= 300; kA = 0; kB = 2; Jump = 0;<BR>fLo = 0; fHi = 250; Kts = 0;<BR>}<BR><BR>TIT 
= 1, 16, Test_TIT_0032, 'Тестовый ТИТ 32'; //<FONT color=#ffff00>TIT = 1, 16- 
первая (нечетная) группа, 32-й ТИТ</FONT><BR>{<BR>aLo = 50; tLo = 100; aHi = 
800; tHi = 700; kA = 0; kB = 4; Jump = 0;<BR>fLo = 0; fHi = 250; Kts = 0; 
Gist=4;<BR>}<BR>}//<FONT color=#ffff00> Скобка конца описания блока 
TIT</FONT><BR></P>
<P>// описание блока ТУ<BR>// TU = &lt;АФБ 1..4&gt;, &lt;Место 0..15&gt;;<BR>TU 
= 3; <FONT color=#000000>//</FONT><FONT color=#000080> описание блока ТИТ, 
установленного на место третьего ФБ</FONT><BR>{//<FONT color=#ffff00> Скобка 
начала описания блока TU</FONT><BR>TURetryOn = 2; // <FONT color=#ffff00>число 
автономных попыток включения ТУ драйвером на этом субблоке при получении команды 
от сервера.</FONT> <FONT color=#ffff00>Подменяет аналогичный параметр в списке 
</FONT><FONT color=#ff0000>параметров по умолчанию-на все КП 
"Гранит"</FONT><BR>TURetryOff = 10; // <FONT color=#ffff00>число автономных 
попыток выключения ТУ драйвером на этом субблоке при получении команды от 
сервера. Подменяет аналогичный параметр в списке </FONT><FONT 
color=#ff0000>параметров по умолчанию-на все КП "Гранит"</FONT><BR>TUSilence = 
10; // <FONT color=#ffff00>пауза перед выдачей ТУ.</FONT> <FONT 
color=#ffff00>Подменяет аналогичный параметр в списке </FONT><FONT 
color=#ff0000>параметров по умолчанию-на все КП "Гранит"</FONT><BR>TUTimeOut = 
40; // <FONT color=#ffff00>таймаут ожидания реакции на ТУ.</FONT> <FONT 
color=#ffff00>Подменяет аналогичный параметр в списке </FONT><FONT 
color=#ff0000>параметров по умолчанию-на все КП "Гранит"</FONT><BR><BR>// <FONT 
color=#ffff00>TU = &lt;группа 1..16&gt;, &lt;номер 1..8&gt; { , &lt;имя&gt;, 
&lt;коммент&gt; };</FONT><BR>TU = 1, 1, пр1900_TU100, 'проба ТУ 
1900';<BR>{<BR>// <FONT color=#ffff00>TSInput = &lt;номер КП 1..127&gt;, 
&lt;номер блока ТС 1..16&gt;, &lt;номер ТС 1..64&gt;;</FONT><BR>TSInput = 1, 1, 
4; // <FONT color=#ffff00>ТС контроля цепи телеуправления</FONT> <BR>//<FONT 
color=#ffff00> TSOutput = &lt;номер КП 1..127&gt;, &lt;номер блока ТС 1..16&gt;, 
&lt;номер ТС 1..64&gt;;</FONT><BR>TSOutput = 1, 1, 3; // <FONT color=#ffff00>ТС, 
контролирующий успешное переключение при подаче ТУ</FONT><BR>}<BR><BR>TU = 1, 2, 
пр1901_TU101, 'проба ТУ 1901';<BR>{ // контролирующий ТС<BR>TSOutput = 13, 1, 
25;<BR>}<BR><BR>TU = 2, 1, пр1902_TU102, 'пр1902';<BR>{ // контролирующий 
ТС<BR>TSOutput = 13, 1, 26;<BR>}<BR>}//<FONT color=#ffff00> Скобка конца 
описания блока TU</FONT><BR><BR>} //<FONT color=#ffff00> Скобка конца описания 
всех КП</FONT><BR></P>
<P>Dev = '/dev/tty05', 38400, 4800; // <FONT color=#ffff00>Описание привязки 
номеров КП "Гранит" к портам ввода-вывода с указанием скоростей 
обмена</FONT><BR>{<BR>KP = 1, 2, 3, 4, 5, 6, 7, 8, 9, 11, 10, 12, 13, 14, 
15;<BR>}<BR><BR>Dev = '/dev/tty06', 38400, 4800;<BR>{<BR>KP = 17, 18, 19, 20, 
21, 22, 23, 24, 25, 26, 27, 28, 30, 31;<BR>}<BR><BR>Dev = '/dev/tty07', 38400, 
4800;<BR>{<BR>KP = 47;<BR>}</P></BODY></HTML>
